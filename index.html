<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
  />

  <link
    rel="apple-touch-icon"
    href="data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' fill='%23ffffff'/%3E%3Cpath fill='%23333333' d='M167.6 412.8c5.6-26.9 11.2-53.5 16.9-79.9 16.7-78.5 33.3-157.1 50-235.7 1.4-6.5 2.7-13.1 4.1-19.6 1.4-6.5 2.8-13 4.2-19.5 2.8-13.1 5.7-26.2 8.5-39.3 3-20.1 6-40.3 8.9-60.4 5.8-40.3 31.1-73.2 68.8-78.1 37.7-4.9 76.3 17.6 89.6 52.9 13.3 35.2 6.7 75.9-14.9 107.3-23.4 33.9-58.6 56.9-98 66.8-39.4 9.9-78.9-15.8-87.4-55.2-8.6-40-23-68.2-44.4-107.2-10.7-19.6-21.5-39-32.5-58.4-11.1-19.4-23-38.2-34.3-57.6-22.6 39.2-45.1 78.5-67.7 117.7-22.6 39.2-45.1 78.5-67.7 117.7-2.7 4.8-5.5 9.6-8.2 14.4-2.8 4.8-5.5 9.6-8.3 14.4-5.5 9.6-11.1 19.1 16.6 28.7-11.1 19.3-22.2 38.5-33.3 57.8-22.2 38.6-44.5 77.1-66.7 115.7-2.3 4-1.1 9.1 2.9 11.4 4.1 2.3 9.1 1.1 11.4-2.9 2.3-4 1.1-9.1-2.9-11.4-4.1-2.3-9.1-1.1-11.4 2.9 22.2 38.6 44.5 77.1 66.7 115.7 11.1 19.3 22.2 38.5 33.3 57.8 5.5 9.6 11.1 19.1 16.6 28.7-2.8 4.8 5.5 9.6 8.3 14.4 2.8 4.8 5.5 9.6 8.2 14.4 22.6 39.2 45.1 78.5 67.7 117.7 22.6 39.2 45.1 78.5 67.7 117.7 11.3 19.4 23.2 38.2 34.3 57.6 11 19.5 21.8 38.8 32.5 58.4 8.5 39.4 47.9 65.1 87.4 55.2 39.4-9.9 72.4-46.1 68.1-85.9-4.3-39.8-31.4-73.4-69.9-82-38.5-8.6-77.1 13.9-90.5 49.2-13.4 35.3-6.7 76 15.1 107.5 21.8 31.5 55 55.1 93.9 60.6 38.9 5.5 76.6-21.1 82.4-59.5 5.8-38.4-18.7-76.4-56.2-84.5-37.6-8.1-75.5 14.5-88.4 49.2-12.9 34.7-6.3 74.8 15.3 105.9 21.6 31.1 54.3 54.5 92.9 59.9 38.6 5.4 76.1-21 81.9-59.2 5.8-38.2-18.6-76-55.9-84.2-37.3-8.2-74.9 14.4-87.8 48.8-12.9 34.4-6.4 74.1 15.1 105 23.1 33.1 57.7 57.4 98.6 64.9 40.9 7.5 80.5-20.9 86.6-61.3 6.1-40.4-19.3-80.1-58.7-88.8-39.5-8.7-79.1 15.3-92.6 51.6-13.6 36.2-6.8 78.2 15.8 109.9 23.6 33.1 58.7 57.2 100.5 64.5 41.8 7.3 82.3-21.6 88.5-62.9 6.1-41.3-19.9-81.9-60.2-90.7-40.3-8.8-80.8 15.8-94.6 52.9-13.8 37.2-6.9 80.3 16.3 112.8 23.9 33.5 59.3 57.7 101.4 64.8 42.1 7.1 82.9-22 89.1-63.8 6.2-41.8-20.1-83-60.8-91.8-40.7-8.9-81.6 15.9-95.6 53.5-14 37.6-7 81.1 16.5 113.9z'/%3E%3C/svg%3E"
  />

  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Piano v39" />

  <title>Piano v39</title>

  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script>
    tailwind.config = { darkMode: 'class' };
  </script>

  <style>
    html { background-color: #f8fafc; transition: background-color 0.3s ease; }
    html.dark { background-color: #0f172a; }
    body { background-color: transparent; overscroll-behavior: none; overflow: hidden; width: 100%; height: 100%; position: fixed; inset: 0; }
    #root { height: 100%; width: 100%; overflow: hidden; display: flex; flex-direction: column; }
    .safe-area-pt { padding-top: env(safe-area-inset-top); }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    /* UPDATED: Added touch-action and overscroll-behavior-y for better scroll handling */
    .scroller-fix { -webkit-overflow-scrolling: touch; min-height: 0; flex: 1 1 0%; touch-action: pan-y; overscroll-behavior-y: contain; }
    .swipe-item { transition: transform 0.2s ease-out; z-index: 20; }
    .swipe-actions { z-index: 10; }

    /* Make native date inputs behave like other inputs (esp. iOS) */
    input[type="date"]{
      -webkit-appearance: none;
      appearance: none;
    }
  </style>
</head>

<body class="text-slate-900 font-sans selection:bg-indigo-200">
  <div id="root"></div>

  <script type="text/babel">
    // =================================================================
    // APP VERSION: v39
    // =================================================================

    const userFirebaseConfig = {
      apiKey: "AIzaSyBtbs3d0ifYfTE2H0ly7-rix0wVhbdf25I",
      authDomain: "piano10000-35804.firebaseapp.com",
      projectId: "piano10000-35804",
      storageBucket: "piano10000-35804.firebasestorage.app",
      messagingSenderId: "1005611018408",
      appId: "1:1005611018408:web:c067db2e119cc9f3a5fa9d",
      measurementId: "G-63W95VNLK6"
    };

    const { useState, useEffect, useMemo, useRef } = React;

    let db = null;
    let isFirebaseEnabled = false;

    try {
      const configToUse =
        (userFirebaseConfig && userFirebaseConfig.apiKey)
          ? userFirebaseConfig
          : (typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null);

      if (configToUse) {
        if (!firebase.apps.length) firebase.initializeApp(configToUse);
        db = firebase.firestore();
        isFirebaseEnabled = true;
        console.log("Firebase initialized (Firestore only)");
      }
    } catch (e) {
      console.warn("Firebase Init Failed:", e);
    }

    const IconMusic = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>;
    const IconPlus = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>;
    const IconList = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>;
    const IconClock = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>;
    const IconTrash = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>;
    const IconEdit = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>;
    const IconCrown = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 4l3 12h14l3-12-6 7-4-7-4 7-6-7zm3 16h14"></path></svg>;
    const IconPlay = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>;
    const IconStop = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg>;
    const IconChevronDown = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M6 9l6 6 6-6"/></svg>;
    const IconStar = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" stroke="none"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>;
    const IconRepeat = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 1l4 4-4 4"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><path d="M7 23l-4-4 4-4"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/></svg>;
    const IconRefresh = () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>;
    const IconCloud = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path></svg>;
    const IconLogOut = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>;
    const IconDot = ({ filled }) => <svg width="12" height="12" viewBox="0 0 24 24" fill={filled ? "currentColor" : "none"} stroke="currentColor" strokeWidth="4" strokeLinecap="round" strokeLinejoin="round" className={filled ? "text-red-500" : "text-slate-300 dark:text-slate-600"}><circle cx="12" cy="12" r="9"></circle></svg>;

    const IconMoon = ({ size = 20, ...props }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
      </svg>
    );
    const IconSun = ({ size = 20, ...props }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
        <circle cx="12" cy="12" r="5"></circle>
        <line x1="12" y1="1" x2="12" y2="3"></line>
        <line x1="12" y1="21" x2="12" y2="23"></line>
        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
        <line x1="1" y1="12" x2="3" y2="12"></line>
        <line x1="21" y1="12" x2="23" y2="12"></line>
        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
      </svg>
    );

    const INITIAL_REPERTOIRE = [];
    const START_DATE = new Date("2024-02-01");

    function weeksSince(dateString) {
      if (!dateString) return null;
      const d = new Date(dateString);
      const now = new Date();
      const diffMs = now - d;
      const diffWeeks = Math.floor(diffMs / (1000 * 60 * 60 * 24 * 7));
      if (diffWeeks < 0) return "Future";
      return `${diffWeeks} weeks`;
    }

    function formatDisplayDate(dateString) {
      if (!dateString) return "";
      return new Date(dateString)
        .toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' })
        .replace(/\//g, '.');
    }

    // UPDATED: Helper function to standardize time format
    function formatAvgTime(str) {
      if (!str) return "";
      if (str.includes('h') && str.includes('m')) return str; // Already formatted
      // Try parsing HH:MM or H:MM
      const match = str.match(/^(\d+):(\d+)$/);
      if (match) {
        const h = parseInt(match[1], 10);
        const m = parseInt(match[2], 10);
        return `${h}h ${m}m`;
      }
      return str;
    }

    const LEGACY_MILESTONES = [
      { hours: 900, date: new Date("2025-11-08"), avg: "1h 24m", type: 'legacy' },
      { hours: 800, date: new Date("2025-08-18"), avg: "1h 25m", type: 'legacy' },
      { hours: 700, date: new Date("2025-06-30"), avg: "1h 22m", type: 'legacy' },
      { hours: 600, date: new Date("2025-04-30"), avg: "1h 20m", type: 'legacy' },
      { hours: 500, date: new Date("2024-12-31"), avg: "1h 29m", type: 'legacy' },
      { hours: 400, date: new Date("2024-11-13"), avg: "1h 24m", type: 'legacy' },
    ];

    function formatDecimalToHMS(decimalHours) {
      const totalSeconds = Math.round(decimalHours * 3600);
      const h = Math.floor(totalSeconds / 3600);
      const m = Math.floor((totalSeconds % 3600) / 60);
      const s = totalSeconds % 60;
      return `${h}h ${m}m ${s}s`;
    }

    function calculateDaysAgo(date) {
      const now = new Date();
      const diffTime = Math.abs(now - date);
      const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
      return diffDays;
    }

    function calculate10kStats(totalHours, totalMinutes) {
      const now = new Date();
      const timeDiff = now - START_DATE;
      const daysPassed = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
      const totalPlayed = parseFloat(totalHours || 0) + (parseFloat(totalMinutes || 0) / 60);
      if (daysPassed <= 0 || totalPlayed === 0) return null;

      const avgHoursPerDay = totalPlayed / daysPassed;
      const percentage = Math.min(100, (totalPlayed / 10000) * 100).toFixed(2);

      const remainingHours = 10000 - totalPlayed;
      const daysRemaining = remainingHours / avgHoursPerDay;
      const finishDate = new Date();
      finishDate.setDate(now.getDate() + daysRemaining);

      const years = Math.floor(daysRemaining / 365);
      const months = Math.floor((daysRemaining % 365) / 30);

      const yearsFormatted = String(years).padStart(2, '0') + ' y';
      const monthsFormatted = String(months).padStart(2, '0') + ' m';

      const nextMilestone = (Math.floor(totalPlayed / 100) + 1) * 100;
      const hoursToMilestone = nextMilestone - totalPlayed;
      const daysToMilestone = Math.ceil(hoursToMilestone / avgHoursPerDay);
      const nextMilestoneDate = new Date();
      nextMilestoneDate.setDate(now.getDate() + daysToMilestone);
      const nextMilestoneDateStr = nextMilestoneDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });

      return {
        daysPassed,
        avgDisplay: formatDecimalToHMS(avgHoursPerDay),
        percentage,
        finishDate: finishDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }),
        yearsFormatted,
        monthsFormatted,
        nextMilestone,
        daysToMilestone,
        nextMilestoneDateStr,
        totalPlayed
      };
    }

    function formatYearsMonthsSincePlain(dateObj) {
      const now = new Date();
      let years = now.getFullYear() - dateObj.getFullYear();
      let months = now.getMonth() - dateObj.getMonth();

      if (now.getDate() < dateObj.getDate()) months -= 1;
      if (months < 0) { years -= 1; months += 12; }
      if (years < 0) years = 0;
      if (months < 0) months = 0;

      return { years, months, text: `${years} year ${months} month` };
    }

    const TenThousandView = ({
      tenKData,
      setTenKData,
      customMilestones,
      addCustomMilestone,
      deleteCustomMilestone,
      editCustomMilestone,
      intervalMilestones,
      setIntervalMilestones,
      legacyMeta,
      setLegacyMeta
    }) => {
      const stats = calculate10kStats(tenKData.hours, tenKData.minutes);

      const [expandedId, setExpandedId] = useState(null);

      const [isModalOpen, setIsModalOpen] = useState(false);
      const [modalStep, setModalStep] = useState('CHOOSE');
      const [modalType, setModalType] = useState(null);
      const [editingMilestone, setEditingMilestone] = useState(null);

      const [formState, setFormState] = useState({
        date: new Date().toISOString().split('T')[0],
        hours: '',
        avg: '',
        title: '',
        description: ''
      });

      const journeyAge = useMemo(() => formatYearsMonthsSincePlain(START_DATE), []);

      const nextIntervalHours = useMemo(() => {
        const hoursSet = new Set([
          ...LEGACY_MILESTONES.map(m => Number(m.hours)),
          ...intervalMilestones.map(m => Number(m.hours)),
        ]);
        let h = 1000;
        while (hoursSet.has(h)) h += 100;
        return h;
      }, [intervalMilestones]);

      const allMilestones = useMemo(() => {
        const legacy = LEGACY_MILESTONES.map(m => ({
          ...m,
          id: `legacy-${m.hours}`,
          type: 'legacy',
          title: `${m.hours} Hours`,
          description: legacyMeta[`legacy-${m.hours}`] || ""
        }));

        const interval = intervalMilestones.map(m => ({
          ...m,
          id: `interval-${m.id}`,
          type: 'interval',
          title: `${m.hours} Hours`,
          date: new Date(m.date),
          description: m.description || "",
          avg: formatAvgTime(m.avg) // UPDATED: Format time
        }));

        const custom = customMilestones.map(m => ({
          ...m,
          id: `custom-${m.id}`,
          type: 'custom',
          date: new Date(m.date),
          title: m.title,
          description: m.description || ""
        }));

        return [...legacy, ...interval, ...custom].sort((a, b) => Number(b.hours) - Number(a.hours));
      }, [customMilestones, intervalMilestones, legacyMeta]);

      const toggleExpand = (id) => setExpandedId(expandedId === id ? null : id);

      const openAdd = () => {
        setIsModalOpen(true);
        setModalStep('CHOOSE');
        setModalType(null);
        setEditingMilestone(null);
      };

      const openEdit = (milestone) => {
        setEditingMilestone(milestone);
        setIsModalOpen(true);
        setModalStep('FORM');
        setModalType('EDIT_DESC');
        setFormState({
          date: milestone.date ? new Date(milestone.date).toISOString().split('T')[0] : new Date().toISOString().split('T')[0],
          hours: milestone.hours ? String(milestone.hours) : '',
          avg: milestone.avg || '',
          title: milestone.title || '',
          description: milestone.description || ''
        });
      };

      const saveEditDescription = () => {
        if (!editingMilestone) return;
        const desc = formState.description || "";

        if (editingMilestone.type === 'legacy') {
          setLegacyMeta(prev => ({ ...prev, [editingMilestone.id]: desc }));
        }
        if (editingMilestone.type === 'interval') {
          const rawId = String(editingMilestone.id).replace('interval-', '');
          setIntervalMilestones(prev => prev.map(m => String(m.id) === rawId ? { ...m, description: desc } : m));
        }
        if (editingMilestone.type === 'custom') {
          const rawId = String(editingMilestone.id).replace('custom-', '');
          editCustomMilestone(Number(rawId), { description: desc });
        }

        setIsModalOpen(false);
        setEditingMilestone(null);
      };

      const deleteEditingMilestone = () => {
        if (!editingMilestone) return;

        if (editingMilestone.type === 'interval') {
          const rawId = String(editingMilestone.id).replace('interval-', '');
          if (confirm("Delete this milestone?")) {
            setIntervalMilestones(prev => prev.filter(m => String(m.id) !== rawId));
            setIsModalOpen(false);
            setEditingMilestone(null);
          }
          return;
        }

        if (editingMilestone.type === 'custom') {
          const rawId = String(editingMilestone.id).replace('custom-', '');
          if (confirm("Delete this milestone?")) {
            deleteCustomMilestone(Number(rawId));
            setIsModalOpen(false);
            setEditingMilestone(null);
          }
          return;
        }

        if (editingMilestone.type === 'legacy') {
          if (confirm("Remove this entry?")) {
            setLegacyMeta(prev => {
              const next = { ...prev };
              delete next[editingMilestone.id];
              return next;
            });
            setIsModalOpen(false);
            setEditingMilestone(null);
          }
        }
      };

      const saveNewMilestone = () => {
        if (modalType === 'INTERVAL') {
          if (!formState.date || !formState.avg || !formState.hours) return;
          setIntervalMilestones(prev => ([
            ...prev,
            { id: Date.now(), date: formState.date, hours: Number(formState.hours), avg: formState.avg, description: formState.description || "" }
          ]));
          setIsModalOpen(false);
          return;
        }

        if (modalType === 'CUSTOM') {
          if (!formState.date || !formState.hours || !formState.title) return;
          addCustomMilestone({
            id: Date.now(),
            date: formState.date,
            hours: Number(formState.hours),
            title: formState.title,
            description: formState.description || "",
            dateCreated: Date.now()
          });
          setIsModalOpen(false);
        }
      };

      const inputClass = "w-full p-3 border border-slate-200 dark:border-slate-600 rounded-xl text-sm outline-none dark:bg-slate-700 dark:text-white";

      return (
        <div className="flex-1 flex flex-col p-6 overflow-y-auto w-full animate-in fade-in zoom-in duration-300 scroller-fix">
          <div className="bg-white dark:bg-slate-800 rounded-2xl p-6 shadow-sm mb-6 border border-slate-100 dark:border-slate-700 z-20 relative">
            <div className="flex justify-between items-center mb-4">
              <h2 className="text-sm font-bold uppercase tracking-wider text-slate-400">Current Progress</h2>
              <button onClick={openAdd} className="text-xs font-bold text-indigo-500 flex items-center gap-1 bg-indigo-50 dark:bg-slate-800 px-3 py-1.5 rounded-full">
                <IconPlus /> Add Milestone
              </button>
            </div>

            <div className="flex gap-4 items-center">
              <div className="flex-1">
                <label className="text-xs text-slate-500 dark:text-slate-400 mb-1 block">Hours</label>
                <input
                  type="number"
                  value={tenKData.hours}
                  onChange={(e) => setTenKData({ ...tenKData, hours: e.target.value })}
                  placeholder="0"
                  className="w-full text-3xl font-bold bg-transparent border-b-2 border-slate-200 dark:border-slate-600 focus:border-indigo-500 outline-none text-slate-900 dark:text-white p-1"
                />
              </div>

              <div className="flex-1">
                <label className="text-xs text-slate-500 dark:text-slate-400 mb-1 block">Minutes</label>
                <input
                  type="number"
                  value={tenKData.minutes}
                  onChange={(e) => setTenKData({ ...tenKData, minutes: e.target.value })}
                  placeholder="0"
                  className="w-full text-3xl font-bold bg-transparent border-b-2 border-slate-200 dark:border-slate-600 focus:border-indigo-500 outline-none text-slate-900 dark:text-white p-1"
                />
              </div>
            </div>
          </div>

          {isModalOpen && (
            <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
              <div className="bg-white dark:bg-slate-800 p-6 rounded-2xl w-full max-w-sm shadow-2xl animate-in zoom-in duration-200">

                {modalStep === 'CHOOSE' && (
                  <>
                    <h3 className="text-sm font-bold text-slate-700 dark:text-slate-300 mb-4">Add Milestone</h3>

                    <div className="space-y-2">
                      <button
                        onClick={() => {
                          setModalType('INTERVAL');
                          setModalStep('FORM');
                          setFormState({
                            date: new Date().toISOString().split('T')[0],
                            hours: String(nextIntervalHours),
                            avg: '',
                            title: '',
                            description: ''
                          });
                        }}
                        className="w-full p-4 rounded-xl border border-slate-200 dark:border-slate-700 text-left"
                      >
                        <div className="text-sm font-bold text-slate-900 dark:text-white">100h Milestone</div>
                      </button>

                      <button
                        onClick={() => {
                          setModalType('CUSTOM');
                          setModalStep('FORM');
                          setFormState({
                            date: new Date().toISOString().split('T')[0],
                            hours: '',
                            avg: '',
                            title: '',
                            description: ''
                          });
                        }}
                        className="w-full p-4 rounded-xl border border-slate-200 dark:border-slate-700 text-left"
                      >
                        <div className="text-sm font-bold text-slate-900 dark:text-white">Custom Milestone</div>
                      </button>
                    </div>

                    <button
                      onClick={() => setIsModalOpen(false)}
                      className="w-full mt-4 bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 py-3 rounded-xl text-sm font-bold"
                    >
                      Cancel
                    </button>
                  </>
                )}

                {modalStep === 'FORM' && modalType !== 'EDIT_DESC' && (
                  <>
                    <h3 className="text-sm font-bold text-slate-700 dark:text-slate-300 mb-4">
                      {modalType === 'INTERVAL' ? '100h Milestone' : 'Custom Milestone'}
                    </h3>

                    <div className="space-y-3">
                      <div>
                        <label className="text-xs font-bold text-slate-500 dark:text-slate-400 mb-1 block">Date</label>
                        <input
                          type="date"
                          value={formState.date}
                          onChange={e => setFormState({ ...formState, date: e.target.value })}
                          className={inputClass}
                          style={{ width: '100%', minWidth: 0 }}
                        />
                      </div>

                      {modalType === 'INTERVAL' && (
                        <>
                          <div>
                            <label className="text-xs font-bold text-slate-500 dark:text-slate-400 mb-1 block">Hours</label>
                            <input
                              type="number"
                              value={formState.hours}
                              onChange={e => setFormState({ ...formState, hours: e.target.value })}
                              className={inputClass}
                              inputMode="numeric"
                            />
                          </div>

                          <div>
                            <label className="text-xs font-bold text-slate-500 dark:text-slate-400 mb-1 block">Avg play time/day (hh:mm)</label>
                            <input
                              type="text"
                              inputMode="numeric"
                              placeholder="01:24"
                              value={formState.avg}
                              onChange={e => setFormState({ ...formState, avg: e.target.value })}
                              className={inputClass}
                            />
                          </div>
                        </>
                      )}

                      {modalType === 'CUSTOM' && (
                        <>
                          <div>
                            <label className="text-xs font-bold text-slate-500 dark:text-slate-400 mb-1 block">At hours</label>
                            <input
                              type="number"
                              placeholder="1050"
                              value={formState.hours}
                              onChange={e => setFormState({ ...formState, hours: e.target.value })}
                              className={inputClass}
                            />
                          </div>

                          <div>
                            <label className="text-xs font-bold text-slate-500 dark:text-slate-400 mb-1 block">Name</label>
                            <input
                              type="text"
                              placeholder="New Piano"
                              value={formState.title}
                              onChange={e => setFormState({ ...formState, title: e.target.value })}
                              className={inputClass}
                            />
                          </div>
                        </>
                      )}

                      <div>
                        <label className="text-xs font-bold text-slate-500 dark:text-slate-400 mb-1 block">Description (optional)</label>
                        <textarea
                          value={formState.description}
                          onChange={e => setFormState({ ...formState, description: e.target.value })}
                          className={`${inputClass} h-24`}
                        />
                      </div>

                      <div className="flex gap-2 pt-1">
                        <button onClick={saveNewMilestone} className="flex-1 bg-indigo-600 text-white py-3 rounded-xl text-sm font-bold">Save</button>
                        <button
                          onClick={() => { setModalStep('CHOOSE'); setModalType(null); setEditingMilestone(null); }}
                          className="flex-1 bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 py-3 rounded-xl text-sm font-bold"
                        >
                          Back
                        </button>
                      </div>
                    </div>
                  </>
                )}

                {modalStep === 'FORM' && modalType === 'EDIT_DESC' && editingMilestone && (
                  <>
                    <h3 className="text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">Edit Description</h3>
                    <div className="text-xs text-slate-400 mb-4">{editingMilestone.title || `${editingMilestone.hours} Hours`}</div>

                    <div className="space-y-3">
                      <textarea
                        value={formState.description}
                        onChange={e => setFormState({ ...formState, description: e.target.value })}
                        className={`${inputClass} h-28`}
                        placeholder="Description..."
                      />

                      <div className="flex gap-2">
                        <button onClick={saveEditDescription} className="flex-1 bg-indigo-600 text-white py-3 rounded-xl text-sm font-bold">Save</button>

                        <button
                          onClick={deleteEditingMilestone}
                          className="px-4 bg-slate-100 dark:bg-slate-700 text-slate-500 dark:text-slate-300 py-3 rounded-xl text-sm font-bold"
                          title="Delete"
                        >
                          <IconTrash />
                        </button>

                        <button
                          onClick={() => { setIsModalOpen(false); setEditingMilestone(null); }}
                          className="flex-1 bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 py-3 rounded-xl text-sm font-bold"
                        >
                          Cancel
                        </button>
                      </div>
                    </div>
                  </>
                )}

              </div>
            </div>
          )}

          {stats ? (
            <>
              <div className="mb-4">
                <div className="flex justify-between text-xs font-bold text-slate-500 dark:text-slate-400 mb-2">
                  <span>MASTERY</span>
                  <span>{stats.percentage}%</span>
                </div>
                <div className="h-6 w-full bg-slate-200 dark:bg-slate-700 rounded-full overflow-hidden shadow-inner relative">
                  <div className="h-full bg-green-500 transition-all duration-1000 ease-out relative" style={{ width: `${stats.percentage}%` }}>
                    <div className="absolute inset-0 bg-white/20"></div>
                  </div>
                </div>
                <div className="flex justify-between mt-2 text-xs text-slate-400 font-mono">
                  <span>Avg: {stats.avgDisplay}/day</span>
                  <span>Day {stats.daysPassed}</span>
                </div>
              </div>

              <div className="relative mt-6 pb-12">
                <div className="absolute left-8 top-8 bottom-10 w-0.5 bg-slate-200 dark:bg-slate-700 -translate-x-1/2 z-0"></div>

                <div className="relative z-10 mb-8 pl-16">
                  <div className="absolute left-8 top-1/2 -translate-y-1/2 -translate-x-1/2 w-3 h-3 rounded-full bg-slate-300 dark:bg-slate-600 ring-4 ring-slate-50 dark:ring-slate-900"></div>
                  <div className="border border-dashed border-slate-300 dark:border-slate-600 rounded-xl p-3 flex justify-between items-center bg-slate-50 dark:bg-slate-800/50">
                    <div>
                      <div className="text-xs font-bold uppercase tracking-wider text-slate-400">Estimated Finish</div>
                      <div className="text-lg font-bold text-slate-700 dark:text-slate-300">{stats.finishDate}</div>
                    </div>
                    <div className="text-right flex flex-col items-end">
                      <span className="text-sm font-bold text-slate-500 dark:text-slate-400">{stats.yearsFormatted}</span>
                      <span className="text-sm font-bold text-slate-500 dark:text-slate-400">{stats.monthsFormatted}</span>
                    </div>
                  </div>
                </div>

                <div className="relative z-10 mb-8 pl-16">
                  <div className="absolute left-8 top-1/2 -translate-y-1/2 -translate-x-1/2 w-3 h-3 rounded-full bg-yellow-400 ring-4 ring-yellow-400/20 shadow-lg shadow-yellow-400/50"></div>
                  <div className="bg-gradient-to-r from-yellow-50 to-white dark:from-slate-800 dark:to-slate-800 border border-yellow-200 dark:border-yellow-900/30 rounded-xl p-4 shadow-sm">
                    <div className="flex justify-between items-center">
                      <div>
                        <div className="text-yellow-600 dark:text-yellow-400 text-xs font-bold uppercase tracking-wider mb-1 flex items-center gap-1">
                          <IconStar /> Next Goal
                        </div>
                        <div className="text-xl font-bold text-slate-900 dark:text-white">{stats.nextMilestone} Hours</div>
                      </div>
                      <div className="text-right">
                        <div className="text-2xl font-bold text-yellow-500">{stats.daysToMilestone}</div>
                        <div className="text-[10px] text-slate-400 uppercase font-bold">{stats.nextMilestoneDateStr}</div>
                      </div>
                    </div>
                  </div>
                </div>

                <div className="relative z-10 mb-8 pl-16">
                  <div className="absolute left-8 top-1/2 -translate-y-1/2 -translate-x-1/2 w-4 h-4 rounded-full bg-green-500 ring-4 ring-green-500/20"></div>
                  <div className="bg-white dark:bg-slate-800 border border-green-200 dark:border-green-900/50 rounded-xl p-4 shadow-sm">
                    <div className="flex justify-between items-center mb-1">
                      <div className="text-green-600 dark:text-green-400 text-xs font-bold uppercase tracking-wider">Current</div>
                      <div className="text-xs text-slate-400">Today</div>
                    </div>
                    <div className="text-2xl font-bold text-slate-900 dark:text-white">
                      {Math.floor(stats.totalPlayed)} <span className="text-sm font-normal text-slate-500">Hours</span>
                    </div>
                  </div>
                </div>

                {allMilestones.map((milestone, idx) => {
                  const isExpanded = expandedId === milestone.id;

                  return (
                    <div
                      key={milestone.id || idx}
                      onClick={() => toggleExpand(milestone.id)}
                      className="relative z-10 mb-8 pl-16 cursor-pointer"
                    >
                      <div className="absolute left-8 top-1/2 -translate-y-1/2 -translate-x-1/2 w-2 h-2 rounded-full bg-slate-300 dark:bg-slate-600"></div>

                      <div className="flex-1">
                        <div className="flex justify-between items-baseline">
                          <span className={`font-bold text-slate-700 dark:text-slate-300 ${milestone.type === 'custom' ? 'text-sm' : 'text-lg'}`}>
                            {milestone.title}
                          </span>

                          {milestone.type === 'custom'
                            ? <span className="text-xs text-slate-400">{milestone.hours} h</span>
                            : <span className="text-xs text-slate-400">{milestone.avg}/day</span>
                          }
                        </div>

                        <div className="text-xs text-slate-400 mt-0.5">
                          {milestone.date ? `${calculateDaysAgo(milestone.date)} days ago` : ''}
                        </div>

                        {isExpanded && (
                          <div className="mt-3 text-sm text-slate-600 dark:text-slate-300 border-t border-slate-200 dark:border-slate-700 pt-2 flex justify-between items-start animate-in fade-in">
                            <div className="flex-1 mr-2 whitespace-pre-wrap">
                              {milestone.description || <span className="text-slate-400 italic">No description...</span>}
                            </div>
                            <button onClick={(e) => { e.stopPropagation(); openEdit(milestone); }} className="text-slate-400 hover:text-indigo-500 p-1">
                              <IconEdit />
                            </button>
                          </div>
                        )}
                      </div>
                    </div>
                  );
                })}

                <div className="relative z-10 pl-16">
                  <div className="absolute left-8 top-1/2 -translate-x-1/2 w-4 h-full bg-slate-50 dark:bg-slate-900 z-0"></div>
                  <div className="absolute left-8 top-1/2 -translate-y-1/2 -translate-x-1/2 w-3 h-3 rounded-full bg-slate-900 dark:bg-white border-2 border-slate-50 dark:border-slate-900 z-10"></div>

                  <div className="flex justify-between items-center">
                    <div>
                      <div className="text-sm font-bold text-slate-900 dark:text-white">Journey Started</div>
                      <div className="text-xs text-slate-400">Feb 1, 2024</div>
                    </div>

                    <div className="text-xs text-slate-400">
                      {journeyAge.text}
                    </div>
                  </div>
                </div>

              </div>
            </>
          ) : (
            <div className="text-center text-slate-400 mt-10 p-6 bg-slate-100 dark:bg-slate-800/50 rounded-2xl">
              Enter your total hours above to generate your timeline.
            </div>
          )}
        </div>
      );
    };

    const RepetitionsView = ({ repState, setRepState }) => {
      const { count, target } = repState;
      const updateCount = (newCount) => setRepState(prev => ({ ...prev, count: newCount }));
      const setTarget = (val) => setRepState(prev => ({ ...prev, target: val, count: val }));

      const triggerConfetti = () => {
        const duration = 3000, animationEnd = Date.now() + duration;
        const randomInOut = (min, max) => Math.random() * (max - min) + min;
        const frame = () => {
          if (animationEnd - Date.now() <= 0) return;
          confetti({
            particleCount: 3,
            startVelocity: 0,
            ticks: 300,
            origin: { x: Math.random(), y: -0.1 },
            gravity: randomInOut(0.5, 1.0),
            scalar: randomInOut(0.8, 1.2),
            drift: randomInOut(-0.4, 0.4),
            colors: ['#6366f1', '#a855f7', '#ec4899', '#3b82f6', '#14b8a6']
          });
          requestAnimationFrame(frame);
        };
        frame();
      };

      const handleTap = () => {
        if (count === 1) triggerConfetti();
        updateCount(count > 0 ? count - 1 : 0);
      };

      const handleReset = () => updateCount(parseInt(target) || 5);
      const handleTargetChange = (e) => {
        const val = parseInt(e.target.value) || 0;
        setRepState(prev => ({ ...prev, target: val, count: val }));
      };

      return (
        <div className="flex-1 flex flex-col p-6 animate-in fade-in zoom-in duration-300 h-full scroller-fix" style={{ paddingBottom: 'env(safe-area-inset-bottom)' }}>
          <div className="flex gap-2 mb-6">
            <button onClick={() => setTarget(5)} className="flex-1 bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-white py-3 rounded-xl font-bold active:scale-95 transition-transform">5</button>
            <button onClick={() => setTarget(20)} className="flex-1 bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-white py-3 rounded-xl font-bold active:scale-95 transition-transform">20</button>
            <div className="flex items-center gap-2 bg-slate-100 dark:bg-slate-800 px-4 rounded-xl border border-slate-200 dark:border-slate-700">
              <span className="text-xs font-bold text-slate-400">Custom:</span>
              <input type="number" value={target} onChange={handleTargetChange} className="w-12 bg-transparent text-right font-bold text-slate-900 dark:text-white outline-none py-3" />
            </div>
          </div>

          <button onClick={handleTap} className="flex-1 bg-gradient-to-br from-indigo-500 to-purple-600 active:scale-[0.98] transition-transform rounded-3xl shadow-xl flex flex-col items-center justify-center text-white mb-6 relative overflow-hidden group">
            <div className="absolute inset-0 bg-white/10 opacity-0 group-active:opacity-100 transition-opacity"></div>
            <div className="text-9xl font-bold tracking-tighter drop-shadow-md select-none">{count}</div>
            <div className="text-white/60 font-medium uppercase tracking-widest mt-2 text-sm">Tap to Reduce</div>
          </button>

          <button onClick={handleReset} className="p-4 bg-slate-100 dark:bg-slate-800 rounded-xl text-slate-500 dark:text-slate-400 font-bold flex items-center justify-center gap-2 active:bg-slate-200 dark:active:bg-slate-700 transition-colors shrink-0">
            <IconRefresh /> Reset Counter
          </button>
        </div>
      );
    };

    // UPDATED: Next Piece button now uses session state logic (pickPiece without args)
    // UPDATED: "Practice Red List" button text changed to "Red List"
    const PracticeView = ({ currentPiece, pickPiece, stopSession, redListCount }) => (
      <div className="flex-1 flex flex-col items-center justify-center p-6 text-center space-y-8 animate-in fade-in duration-300 w-full overflow-hidden scroller-fix">
        {currentPiece ? (
          <div className="w-full">
            <div className="text-sm uppercase tracking-widest text-slate-400 dark:text-slate-500 mb-2">Please Play</div>
            <div className="text-3xl font-serif font-medium text-slate-900 dark:text-white leading-tight mb-8">{currentPiece.title}</div>
            <div className="inline-block px-3 py-1 bg-slate-100 dark:bg-slate-800 rounded-full text-xs text-slate-500 dark:text-slate-400">Total Plays: {currentPiece.playCount}</div>
          </div>
        ) : <div className="text-slate-400 dark:text-slate-500 italic">Tap below to pick a piece</div>}

        <div className="flex flex-col gap-4 w-full max-w-sm">
          <button onClick={() => pickPiece()} className="bg-indigo-600 active:bg-indigo-700 dark:bg-indigo-500 dark:active:bg-indigo-600 text-white text-xl font-bold py-6 px-12 rounded-2xl shadow-xl shadow-indigo-200 dark:shadow-none transition-all transform active:scale-95 w-full">
            {currentPiece ? "Next Piece" : "Start Session"}
          </button>

          {!currentPiece && (
            <button onClick={() => pickPiece(true)} className="border-2 border-red-500 text-red-500 active:bg-red-50 dark:active:bg-red-900/20 text-sm font-bold py-3 px-6 rounded-xl transition-all transform active:scale-95 w-full flex items-center justify-center gap-2">
              <IconDot filled={true} /> Red List ({redListCount})
            </button>
          )}

          {currentPiece && (
            <button onClick={stopSession} className="flex items-center justify-center gap-2 bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-300 font-bold py-4 rounded-xl active:scale-95 transition-all">
              <IconStop /> Stop Session
            </button>
          )}
        </div>
      </div>
    );

    const RepertoireView = ({ sortedPieces, deletePiece, editPiece, toggleRedList, isRedListMode, toggleRedPiece }) => {
      const displayedPieces = isRedListMode ? sortedPieces.filter(p => p.isRed) : sortedPieces;

      const [swipedId, setSwipedId] = useState(null);
      const [editingId, setEditingId] = useState(null);
      const [editForm, setEditForm] = useState({ title: '', date: '' });
      const touchStartX = useRef(null);

      const handleTouchStart = (e) => { touchStartX.current = e.touches[0].clientX; };

      const handleTouchEnd = (e, id) => {
        if (!touchStartX.current) return;
        const endX = e.changedTouches[0].clientX;
        const diff = touchStartX.current - endX;
        if (diff > 50) setSwipedId(id);
        else if (diff < -50) { if (swipedId === id) setSwipedId(null); }
        touchStartX.current = null;
      };

      const startEdit = (piece) => {
        setEditingId(piece.id);
        setEditForm({ title: piece.title, date: piece.startDate || '' });
      };

      const saveEdit = () => {
        if (editForm.title && editingId) {
          editPiece(editingId, { title: editForm.title, startDate: editForm.date });
          setEditingId(null);
          setSwipedId(null);
        }
      };

      const clearDate = () => setEditForm({ ...editForm, date: '' });

      return (
        <div className="flex-1 overflow-y-auto p-4 animate-in slide-in-from-right duration-300 w-full no-scrollbar scroller-fix" style={{ paddingBottom: 'env(safe-area-inset-bottom)' }}>
          <div className="flex items-center justify-between mb-4 px-2">
            <div className="text-sm font-bold uppercase tracking-wider text-slate-400">My Repertoire</div>
            <button onClick={toggleRedList} className={`flex items-center gap-1 text-xs font-bold px-3 py-1 rounded-full border transition-all ${isRedListMode ? 'bg-red-500 text-white border-red-500' : 'bg-transparent text-slate-400 border-slate-300 dark:border-slate-600'}`}>
              <IconDot filled={isRedListMode} /> {isRedListMode ? 'Red List Active' : 'Show Red List'}
            </button>
          </div>

          {editingId && (
            <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
              <div className="bg-white dark:bg-slate-800 p-6 rounded-2xl w-full max-w-sm shadow-2xl animate-in zoom-in duration-200">
                <h3 className="text-sm font-bold text-slate-700 dark:text-slate-300 mb-4">Edit Piece</h3>
                <div className="space-y-3">
                  <input value={editForm.title} onChange={(e) => setEditForm({ ...editForm, title: e.target.value })} className="w-full p-3 border border-slate-200 dark:border-slate-600 rounded-xl text-lg outline-none dark:bg-slate-700 dark:text-white" />
                  <div className="flex gap-2">
                    <input type="date" value={editForm.date} onChange={(e) => setEditForm({ ...editForm, date: e.target.value })} className="w-full p-3 border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-xl text-sm outline-none dark:text-white" />
                    <button onClick={clearDate} className="bg-slate-100 dark:bg-slate-700 text-slate-500 p-3 rounded-xl"><IconTrash /></button>
                  </div>
                  <div className="flex gap-2 pt-2">
                    <button onClick={saveEdit} className="flex-1 bg-indigo-600 text-white py-3 rounded-xl text-sm font-bold">Save</button>
                    <button onClick={() => setEditingId(null)} className="flex-1 bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 py-3 rounded-xl text-sm font-bold">Cancel</button>
                  </div>
                </div>
              </div>
            </div>
          )}

          <div className="space-y-3 pb-8">
            {[...displayedPieces].sort((a, b) => b.id - a.id).map((piece) => {
              const isSwiped = swipedId === piece.id;
              const weeksAgo = weeksSince(piece.startDate);

              return (
                <div
                  key={piece.id}
                  className="relative rounded-xl overflow-hidden isolate bg-white dark:bg-slate-800 border border-slate-100 dark:border-slate-700"
                  style={{ backgroundClip: 'padding-box' }}
                >
                  <div className="absolute inset-0 z-0 flex justify-end bg-white dark:bg-slate-800">
                    <button onClick={() => startEdit(piece)} className="bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300 font-bold w-20 flex items-center justify-center">Edit</button>
                    <button onClick={() => deletePiece(piece.id)} className="bg-red-500 text-white font-bold w-24 flex items-center justify-center">Delete</button>
                  </div>

                  <div
                    className="absolute inset-0 z-10 bg-white dark:bg-slate-800 shadow-sm p-4 flex items-center justify-between swipe-item"
                    onTouchStart={handleTouchStart}
                    onTouchEnd={(e) => handleTouchEnd(e, piece.id)}
                    style={{
                      backfaceVisibility: 'hidden',
                      willChange: 'transform',
                      transform: isSwiped ? 'translate3d(-11rem,0,0)' : 'translate3d(0,0,0)'
                    }}
                  >
                    <div className="flex-1 pr-4 pl-2">
                      <h3 className="font-medium text-slate-900 dark:text-white">{piece.title}</h3>
                      {weeksAgo && (
                        <div className="text-[10px] text-slate-400 mt-1 font-mono">
                          Started: {formatDisplayDate(piece.startDate)}  {weeksAgo}
                        </div>
                      )}
                    </div>
                    <button onClick={(e) => { e.stopPropagation(); toggleRedPiece(piece.id); }} className="p-2 active:scale-90 transition-transform">
                      <IconDot filled={piece.isRed} />
                    </button>
                  </div>

                  <div className="h-[72px]"></div>
                </div>
              );
            })}
            {displayedPieces.length === 0 && <div className="text-center text-slate-400 mt-10 p-6">No pieces found.</div>}
          </div>
        </div>
      );
    };

    const LeaderboardView = ({ sortedPieces }) => (
      <div className="flex-1 overflow-y-auto p-4 animate-in slide-in-from-right duration-300 w-full no-scrollbar scroller-fix" style={{ paddingBottom: 'env(safe-area-inset-bottom)' }}>
        <div className="text-sm font-bold uppercase tracking-wider text-slate-400 mb-4 px-2">Most Played</div>
        <div className="space-y-3 pb-8">
          {sortedPieces.map((piece, index) => (
            <div key={piece.id} className="flex items-center justify-between p-4 bg-white dark:bg-slate-800 rounded-xl border border-slate-100 dark:border-slate-700 shadow-sm relative overflow-hidden">
              <div className="absolute -left-2 -bottom-4 text-6xl font-bold text-slate-50 dark:text-slate-700/50 pointer-events-none z-0">{index + 1}</div>
              <div className="flex-1 pr-4 z-10 pl-2">
                <h3 className="font-medium text-slate-900 dark:text-white">{piece.title}</h3>
                <p className="text-xs text-slate-400 mt-1">Played {piece.playCount || 0} times</p>
              </div>
            </div>
          ))}
          {sortedPieces.length === 0 && <div className="text-center text-slate-400 mt-10 p-6">No pieces yet. Add one below!</div>}
        </div>
      </div>
    );

    const SettingsView = ({ syncStatus, isFirebaseEnabled, syncId, setSyncId, handleLogout, isDark, setIsDark }) => {
      const [localInput, setLocalInput] = useState("");
      const handleConnect = () => { if (localInput.trim()) setSyncId(localInput.trim()); };
      const handleKeyDown = (e) => { if (e.key === 'Enter') handleConnect(); };

      return (
        <div className="flex-1 overflow-y-auto p-4 animate-in slide-in-from-right duration-300 w-full no-scrollbar scroller-fix" style={{ paddingBottom: 'env(safe-area-inset-bottom)' }}>
          <div className="text-sm font-bold uppercase tracking-wider text-slate-400 mb-4 px-2">Settings</div>

          <div className="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl p-4 mb-6">
            <div className="flex items-center justify-between mb-4">
              <div className="text-sm font-bold text-slate-900 dark:text-white">Cloud Sync</div>
              {syncStatus === 'synced' && <div className="text-xs text-green-500 font-bold flex gap-2 items-center">Connected</div>}
              {syncStatus === 'syncing' && <div className="text-xs text-indigo-500 font-bold animate-pulse">Syncing...</div>}
              {syncStatus === 'error' && <div className="text-xs text-red-500 font-bold">Offline</div>}
              {syncStatus === 'disconnected' && <div className="text-xs text-slate-400 font-bold">Disconnected</div>}
            </div>

            {!isFirebaseEnabled ? (
              <div className="text-center">
                <div className="text-slate-300 mb-2"><IconCloud /></div>
                <p className="text-xs text-slate-500 dark:text-slate-400 mb-2">Cloud sync is not configured.</p>
              </div>
            ) : (
              <div>
                {syncId ? (
                  <div className="flex flex-col gap-3">
                    <div className="p-3 bg-slate-100 dark:bg-slate-900 rounded-lg flex justify-between items-center">
                      <div className="text-xs font-mono text-slate-500">ID: {syncId.slice(-3)}</div>
                      <button onClick={handleLogout} className="text-xs font-bold text-red-500 flex items-center gap-1"><IconLogOut /> Disconnect</button>
                    </div>
                  </div>
                ) : (
                  <>
                    <label className="text-xs font-bold text-slate-500 dark:text-slate-400 mb-2 block">Secret Passphrase</label>
                    <div className="flex gap-2">
                      <input
                        type="text"
                        value={localInput}
                        onChange={(e) => setLocalInput(e.target.value)}
                        onKeyDown={handleKeyDown}
                        placeholder="e.g. MyPiano2025"
                        className="flex-1 bg-slate-100 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg px-3 py-2 text-sm outline-none focus:border-indigo-500 dark:text-white"
                      />
                      <button onClick={handleConnect} className="bg-indigo-600 text-white px-4 rounded-lg text-sm font-bold">Connect</button>
                    </div>
                  </>
                )}
              </div>
            )}
          </div>

          <div className="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl p-4 mb-6 flex justify-between items-center">
            <div className="text-sm font-bold text-slate-900 dark:text-white">Dark Mode</div>
            <button onClick={() => setIsDark(!isDark)} className={`w-12 h-7 rounded-full p-1 transition-colors duration-300 flex items-center ${isDark ? 'bg-indigo-600 justify-end' : 'bg-slate-200 justify-start'}`}>
              <div className="w-5 h-5 rounded-full bg-white shadow-sm flex items-center justify-center text-slate-800">
                {isDark ? <IconMoon size={12} /> : <IconSun size={12} />}
              </div>
            </button>
          </div>

          <div className="px-2 text-center text-xs text-slate-400">
            Piano v39<br />Build: 01.01.2026
          </div>
        </div>
      );
    };

    const HistoryView = ({ history, replayPieceFromHistory, deleteHistoryEntry, formatTime }) => (
      <div className="flex-1 overflow-y-auto p-4 animate-in slide-in-from-right duration-300 w-full no-scrollbar scroller-fix" style={{ paddingBottom: 'env(safe-area-inset-bottom)' }}>
        <div className="text-sm font-bold uppercase tracking-wider text-slate-400 mb-4 px-2">Recent Activity</div>
        {history.length === 0 && <div className="text-center text-slate-400 mt-10 italic">No history yet. Start playing!</div>}
        <div className="space-y-3 pb-24">
          {history.map((entry) => (
            <div key={entry.historyId} className="flex items-center justify-between p-3 bg-white dark:bg-slate-800 rounded-xl border border-slate-100 dark:border-slate-700 shadow-sm">
              <div className="flex flex-col">
                <span className="text-xs text-slate-400 font-mono">{formatTime(entry.timestamp)}</span>
                <span className="font-medium text-slate-900 dark:text-white text-sm line-clamp-1">{entry.title}</span>
              </div>
              <div className="flex items-center gap-2">
                <button onClick={() => replayPieceFromHistory(entry.pieceId)} className="p-2 text-indigo-400 active:text-indigo-600 dark:text-indigo-400 dark:active:text-indigo-200 bg-indigo-50 dark:bg-indigo-900/30 rounded-lg"><IconPlus /></button>
                <button onClick={() => deleteHistoryEntry(entry.historyId, entry.pieceId)} className="p-2 text-slate-300 active:text-slate-500 rounded-lg"><IconTrash /></button>
              </div>
            </div>
          ))}
        </div>
      </div>
    );

    function App() {
      const [appMode, setAppMode] = useState('REPERTOIRE');
      const [view, setView] = useState('PRACTICE');

      const [isDark, setIsDark] = useState(() => {
        const stored = localStorage.getItem('pianoTheme');
        return stored ? stored === 'dark' : true;
      });

      const [syncId, setSyncId] = useState(() => localStorage.getItem('pianoSyncId') || "");
      const [syncStatus, setSyncStatus] = useState("disconnected");
      const isCloudReady = useRef(false);

      const saveData = async (key, data) => {
        localStorage.setItem(key, JSON.stringify(data));
        if (isFirebaseEnabled && syncId && db && isCloudReady.current) {
          setSyncStatus("syncing");
          try {
            await db.collection('piano_users').doc(syncId).set({
              [key]: data,
              lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });
            setSyncStatus("synced");
          } catch (e) {
            console.error("Cloud Save Error", e);
            setSyncStatus("error");
          }
        }
      };

      useEffect(() => {
        if (isFirebaseEnabled && syncId && db) {
          setSyncStatus("syncing");
          isCloudReady.current = false;
          db.collection('piano_users').doc(syncId).get().then(doc => {
            if (doc.exists) {
              const data = doc.data();
              if (data.pianoRepertoire_v9) setPieces(data.pianoRepertoire_v9);
              if (data.piano10k_v1) setTenKData(data.piano10k_v1);
              if (data.pianoHistory_v1) setHistory(data.pianoHistory_v1);
              if (data.pianoDailyStats_v1) setDailyStats(data.pianoDailyStats_v1);
              if (data.pianoCustomMilestones_v1) setCustomMilestones(data.pianoCustomMilestones_v1);
              if (data.pianoLegacyMeta_v1) setLegacyMeta(data.pianoLegacyMeta_v1);
              if (data.pianoIntervalMilestones_v1) setIntervalMilestones(data.pianoIntervalMilestones_v1);
              setSyncStatus("synced");
            } else {
              setSyncStatus("synced");
            }
          }).catch(err => {
            console.error("Cloud Load Error", err);
            setSyncStatus("error");
          }).finally(() => {
            isCloudReady.current = true;
          });
        } else if (!syncId) {
          setSyncStatus("disconnected");
        }
      }, [syncId]);

      const [pieces, setPieces] = useState(() => {
        const saved = localStorage.getItem('pianoRepertoire_v9');
        return saved ? JSON.parse(saved) : INITIAL_REPERTOIRE;
      });

      const [tenKData, setTenKData] = useState(() => {
        const saved = localStorage.getItem('piano10k_v1');
        return saved ? JSON.parse(saved) : { hours: "", minutes: "" };
      });

      const [customMilestones, setCustomMilestones] = useState(() => {
        const saved = localStorage.getItem('pianoCustomMilestones_v1');
        return saved ? JSON.parse(saved) : [];
      });

      const [intervalMilestones, setIntervalMilestones] = useState(() => {
        const saved = localStorage.getItem('pianoIntervalMilestones_v1');
        return saved ? JSON.parse(saved) : [];
      });

      const [legacyMeta, setLegacyMeta] = useState(() => {
        const saved = localStorage.getItem('pianoLegacyMeta_v1');
        return saved ? JSON.parse(saved) : {};
      });

      const [repState, setRepState] = useState(() => ({ count: 5, target: 5, mode: 'DOWN' }));

      const [history, setHistory] = useState(() => {
        const saved = localStorage.getItem('pianoHistory_v1');
        return saved ? JSON.parse(saved) : [];
      });

      const [dailyStats, setDailyStats] = useState(() => {
        const saved = JSON.parse(localStorage.getItem('pianoDailyStats_v1') || '{}');
        const today = new Date().toDateString();
        if (saved.date !== today) return { date: today, count: 0 };
        return saved;
      });

      const [currentPiece, setCurrentPiece] = useState(null);

      const [newPieceTitle, setNewPieceTitle] = useState("");
      const [newPieceDate, setNewPieceDate] = useState("");
      const [isAdding, setIsAdding] = useState(false);

      const [isRedListMode, setIsRedListMode] = useState(false);

      // UPDATED: New state to track if the current practice session is filtered (Red List)
      const [sessionFilter, setSessionFilter] = useState(false);

      const sortedPieces = useMemo(() => [...pieces].sort((a, b) => (b.playCount || 0) - (a.playCount || 0)), [pieces]);

      useEffect(() => { saveData('pianoRepertoire_v9', pieces); }, [pieces]);
      useEffect(() => { saveData('pianoHistory_v1', history); }, [history]);
      useEffect(() => { saveData('pianoDailyStats_v1', dailyStats); }, [dailyStats]);
      useEffect(() => { saveData('piano10k_v1', tenKData); }, [tenKData]);
      useEffect(() => { saveData('pianoCustomMilestones_v1', customMilestones); }, [customMilestones]);
      useEffect(() => { saveData('pianoLegacyMeta_v1', legacyMeta); }, [legacyMeta]);
      useEffect(() => { saveData('pianoIntervalMilestones_v1', intervalMilestones); }, [intervalMilestones]);

      useEffect(() => { if (syncId) localStorage.setItem('pianoSyncId', syncId); }, [syncId]);

      useEffect(() => {
        if (isDark) {
          document.documentElement.classList.add('dark');
          localStorage.setItem('pianoTheme', 'dark');
          const metaThemeColor = document.querySelector("meta[name=theme-color]");
          if (metaThemeColor) metaThemeColor.setAttribute("content", "#0f172a");
        } else {
          document.documentElement.classList.remove('dark');
          localStorage.setItem('pianoTheme', 'light');
          const metaThemeColor = document.querySelector("meta[name=theme-color]");
          if (metaThemeColor) metaThemeColor.setAttribute("content", "#f8fafc");
        }
      }, [isDark]);

      const recordPlay = (piece) => {
        const now = Date.now();
        setPieces(pieces.map(p => p.id === piece.id ? { ...p, lastPlayed: now, playCount: (p.playCount || 0) + 1 } : p));

        const newHistoryEntry = { historyId: Date.now(), pieceId: piece.id, title: piece.title, timestamp: now };
        setHistory([newHistoryEntry, ...history]);

        const todayStr = new Date().toDateString();
        setDailyStats(prev => {
          if (prev.date !== todayStr) return { date: todayStr, count: 1 };
          return { ...prev, count: prev.count + 1 };
        });
      };

      // UPDATED: Logic to persist red list session until stop
      const pickPiece = (filterRed) => {
        // If argument provided, it's a new session start (setting the mode)
        // If no argument, use current sessionFilter state
        let isRed = sessionFilter;
        if (typeof filterRed === 'boolean') {
          isRed = filterRed;
          setSessionFilter(filterRed);
        }

        const pool = isRed ? pieces.filter(p => p.isRed) : pieces;
        if (pool.length === 0) return alert(isRed ? "Red List is empty!" : "No pieces available!");

        const now = Date.now();
        const candidates = pool.map(p => {
          const timeSinceLastPlayed = p.lastPlayed === 0 ? 100000000000 : now - p.lastPlayed;
          const randomFactor = 0.5 + Math.random();
          return { ...p, score: timeSinceLastPlayed * randomFactor };
        });
        candidates.sort((a, b) => b.score - a.score);
        const winner = candidates[0];
        setCurrentPiece(winner);
        recordPlay(winner);
      };

      const stopSession = () => {
        setCurrentPiece(null);
        setSessionFilter(false); // UPDATED: Reset session filter
      };

      const replayPieceFromHistory = (pieceId) => {
        const piece = pieces.find(p => p.id === pieceId);
        if (piece) recordPlay(piece);
      };

      const deleteHistoryEntry = (historyId, pieceId) => {
        const entry = history.find(h => h.historyId === historyId);
        if (entry) {
          const isToday = new Date(entry.timestamp).toDateString() === new Date().toDateString();
          if (isToday) setDailyStats(prev => ({ ...prev, count: Math.max(0, prev.count - 1) }));
        }
        setHistory(history.filter(h => h.historyId !== historyId));
        setPieces(pieces.map(p => p.id === pieceId ? { ...p, playCount: Math.max(0, (p.playCount || 0) - 1) } : p));
      };

      const handleStartAdd = () => {
        setNewPieceTitle(`${pieces.length + 1}. `);
        setNewPieceDate(new Date().toISOString().split('T')[0]);
        setIsAdding(true);
      };

      const addNewPiece = () => {
        if (!newPieceTitle.trim()) return;
        const newPiece = { id: Date.now(), title: newPieceTitle, startDate: newPieceDate, lastPlayed: 0, playCount: 0, isRed: false };
        setPieces([newPiece, ...pieces]);
        setNewPieceTitle("");
        setIsAdding(false);
      };

      const deletePiece = (id) => { if (confirm("Delete this piece from your repertoire?")) setPieces(pieces.filter(p => p.id !== id)); };
      const editPiece = (id, updated) => setPieces(pieces.map(p => p.id === id ? { ...p, ...updated } : p));
      const toggleRedPiece = (id) => setPieces(pieces.map(p => p.id === id ? { ...p, isRed: !p.isRed } : p));

      const addCustomMilestone = (milestone) => setCustomMilestones([...customMilestones, { ...milestone, id: milestone.id || Date.now() }]);
      const deleteCustomMilestone = (id) => setCustomMilestones(customMilestones.filter(m => m.id !== id));
      const editCustomMilestone = (id, updated) => setCustomMilestones(customMilestones.map(m => m.id === id ? { ...m, ...updated } : m));

      const handleLogout = () => {
        if (confirm("Are you sure? This will disconnect cloud sync and clear all local data.")) {
          setSyncId("");
          localStorage.removeItem('pianoSyncId');
          setPieces(INITIAL_REPERTOIRE);
          setHistory([]);
          setTenKData({ hours: "", minutes: "" });
          setDailyStats({ date: new Date().toDateString(), count: 0 });
          setCustomMilestones([]);
          setIntervalMilestones([]);
          setLegacyMeta({});
          setSyncStatus("disconnected");
        }
      };

      const formatTime = (ts) => new Date(ts).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

      const cycleMode = () => {
        if (appMode === 'REPERTOIRE') setAppMode('10K');
        else if (appMode === '10K') setAppMode('REPS');
        else setAppMode('REPERTOIRE');
      };

      return (
        <div className="flex flex-col h-full bg-slate-50 dark:bg-slate-900 transition-colors duration-300 safe-area-pt overflow-hidden">
          <div className="p-4 bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 shadow-sm flex justify-between items-center shrink-0 z-10 relative">
            <button onClick={cycleMode} className="flex flex-col items-start justify-center h-10">
              <h1 className="text-lg font-bold flex items-center gap-2 text-slate-900 dark:text-white active:opacity-50 transition-opacity">
                {appMode === 'REPERTOIRE' && <><IconMusic /> Repertoire <IconChevronDown /></>}
                {appMode === '10K' && <><IconClock /> 10,000 Hours <IconChevronDown /></>}
                {appMode === 'REPS' && <><IconRepeat /> Repetitions <IconChevronDown /></>}
              </h1>
            </button>

            {appMode === 'REPERTOIRE' && (
              <div className="flex gap-2 bg-slate-100 dark:bg-slate-700 p-1 rounded-full items-center">
                <button onClick={() => setView('PRACTICE')} className={`p-2 rounded-full transition-colors ${view === 'PRACTICE' ? 'bg-white shadow text-indigo-600 dark:bg-slate-600 dark:text-white' : 'text-slate-400'}`}><IconPlay /></button>
                <button onClick={() => setView('REPERTOIRE')} className={`p-2 rounded-full transition-colors ${view === 'REPERTOIRE' ? 'bg-white shadow text-indigo-600 dark:bg-slate-600 dark:text-white' : 'text-slate-400'}`}><IconList /></button>
                <button onClick={() => setView('LEADERBOARD')} className={`p-2 rounded-full transition-colors ${view === 'LEADERBOARD' ? 'bg-white shadow text-indigo-600 dark:bg-slate-600 dark:text-white' : 'text-slate-400'}`}><IconCrown /></button>
                <button onClick={() => setView('HISTORY')} className={`p-2 rounded-full transition-colors ${view === 'HISTORY' ? 'bg-white shadow text-indigo-600 dark:bg-slate-600 dark:text-white' : 'text-slate-400'}`}><IconClock /></button>
                <button onClick={() => setView('SETTINGS')} className={`px-3 py-1 ml-1 rounded-full text-xs font-bold transition-colors ${view === 'SETTINGS' ? 'bg-white shadow text-indigo-600 dark:bg-slate-600 dark:text-white' : 'text-slate-400 bg-slate-200 dark:bg-slate-800'}`}>v39</button>
              </div>
            )}
          </div>

          {appMode === 'REPERTOIRE' && (
            <div className="bg-slate-100 dark:bg-slate-900/50 border-b border-slate-200 dark:border-slate-700 py-1.5 px-4 flex justify-center items-center gap-4 text-xs font-mono text-slate-500 dark:text-slate-400 shrink-0 z-0">
              <span>Today: <strong className="text-slate-700 dark:text-slate-200">{dailyStats.count}</strong></span>
              <span className="text-slate-300 dark:text-slate-600">|</span>
              <span>Total: <strong className="text-slate-700 dark:text-slate-200">{pieces.reduce((sum, p) => sum + (p.playCount || 0), 0)}</strong></span>
            </div>
          )}

          <div className="flex-1 overflow-hidden relative flex flex-col">
            {appMode === '10K' && (
              <TenThousandView
                tenKData={tenKData}
                setTenKData={setTenKData}
                customMilestones={customMilestones}
                addCustomMilestone={addCustomMilestone}
                deleteCustomMilestone={deleteCustomMilestone}
                editCustomMilestone={editCustomMilestone}
                intervalMilestones={intervalMilestones}
                setIntervalMilestones={setIntervalMilestones}
                legacyMeta={legacyMeta}
                setLegacyMeta={setLegacyMeta}
              />
            )}

            {appMode === 'REPS' && <RepetitionsView repState={repState} setRepState={setRepState} />}

            {appMode === 'REPERTOIRE' && (
              <>
                {view === 'PRACTICE' && <PracticeView currentPiece={currentPiece} pickPiece={pickPiece} stopSession={stopSession} redListCount={pieces.filter(p => p.isRed).length} />}
                {view === 'REPERTOIRE' && <RepertoireView sortedPieces={pieces} deletePiece={deletePiece} editPiece={editPiece} toggleRedList={() => setIsRedListMode(!isRedListMode)} isRedListMode={isRedListMode} toggleRedPiece={toggleRedPiece} />}
                {view === 'LEADERBOARD' && <LeaderboardView sortedPieces={sortedPieces} />}
                {view === 'HISTORY' && <HistoryView history={history} replayPieceFromHistory={replayPieceFromHistory} deleteHistoryEntry={deleteHistoryEntry} formatTime={formatTime} />}
                {view === 'SETTINGS' && <SettingsView syncStatus={syncStatus} isFirebaseEnabled={isFirebaseEnabled} syncId={syncId} setSyncId={setSyncId} handleLogout={handleLogout} isDark={isDark} setIsDark={setIsDark} />}
              </>
            )}
          </div>

          {appMode === 'REPERTOIRE' && (view === 'PRACTICE' || view === 'REPERTOIRE' || view === 'LEADERBOARD') && (
            <div className="p-6 bg-white dark:bg-slate-800 border-t border-slate-200 dark:border-slate-700 shrink-0 z-10 w-full" style={{ paddingBottom: 'env(safe-area-inset-bottom)' }}>
              {isAdding ? (
                <div className="space-y-3">
                  <input
                    autoFocus
                    value={newPieceTitle}
                    onChange={(e) => setNewPieceTitle(e.target.value)}
                    placeholder="e.g. 27. Rachmaninoff..."
                    className="w-full p-4 border border-slate-300 dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-xl text-lg outline-none focus:border-indigo-500"
                  />
                  <div className="flex gap-2 items-center">
                    <label className="text-xs font-bold text-slate-500">Started:</label>
                    <input type="date" value={newPieceDate} onChange={(e) => setNewPieceDate(e.target.value)} className="flex-1 p-2 border border-slate-300 dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-lg text-sm outline-none" />
                  </div>
                  <div className="flex gap-2">
                    <button onClick={addNewPiece} className="flex-1 bg-indigo-600 text-white py-3 rounded-xl font-semibold">Save</button>
                    <button onClick={() => setIsAdding(false)} className="flex-1 bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 py-3 rounded-xl font-semibold">Cancel</button>
                  </div>
                </div>
              ) : (
                <button onClick={handleStartAdd} className="flex items-center justify-center gap-2 w-full p-4 text-slate-500 dark:text-slate-400 hover:text-indigo-600 dark:hover:text-indigo-400 font-medium transition-colors">
                  <IconPlus /> Add New Piece
                </button>
              )}
            </div>
          )}
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
